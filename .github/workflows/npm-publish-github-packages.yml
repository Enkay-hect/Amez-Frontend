name: Deploy to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: SSH into EC2 and deploy
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          password: ${{ secrets.EC2_PASSWORD }}  # Use password instead of key
          script: |
            set -e
            
            echo "🚀 Starting deployment..."
            
            # Install Node.js if not present
            if ! command -v node &> /dev/null; then
              echo "📦 Installing Node.js..."
              curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
              sudo apt-get install -y nodejs
            fi
            
            # Install Git if not present
            if ! command -v git &> /dev/null; then
              echo "📦 Installing Git..."
              sudo apt-get update
              sudo apt-get install -y git
            fi
            
            # Set up deployment directory
            DEPLOY_DIR="$HOME/frontend"
            REPO_URL="https://github.com/Enkay-hect/Amez-Frontend.git"
            
            echo "📁 Preparing deployment directory..."
            
            # Remove existing directory if it exists
            if [ -d "$DEPLOY_DIR" ]; then
              echo "🧹 Cleaning existing deployment..."
              rm -rf "$DEPLOY_DIR"
            fi
            
            # Clone repository
            echo "📥 Cloning repository..."
            git clone "$REPO_URL" "$DEPLOY_DIR"
            
            # Navigate to project directory
            cd "$DEPLOY_DIR"
            
            # Verify package.json exists
            if [ ! -f "package.json" ]; then
              echo "❌ package.json not found!"
              echo "📋 Directory contents:"
              ls -la
              exit 1
            fi
            
            # Install dependencies
            echo "📦 Installing dependencies..."
            npm install
            
            # Build project
            echo "🔨 Building project..."
            npm run build
            
            # Optional: Start/restart application
            # If you're using PM2:
            # if command -v pm2 &> /dev/null; then
            #   echo "🔄 Restarting application with PM2..."
            #   pm2 restart frontend || pm2 start npm --name "frontend" -- start
            # else
            #   echo "⚠️  PM2 not found. Consider installing it for process management."
            # fi
            
            echo "✅ Deployment completed successfully!"
            echo "📊 Final directory structure:"
            ls -la

